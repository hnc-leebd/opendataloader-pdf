name: "Stage 1: Quick Triage"

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

env:
  DAILY_LIMIT: 20  # Triage limit per day

jobs:
  quick-triage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      actions: read

    if: |
      github.event_name == 'workflow_dispatch' ||
      !contains(github.event.issue.labels.*.name, 'triaged')

    steps:
      - name: Check daily limit
        id: limit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check today's successful workflow runs
          TODAY=$(date -u +%Y-%m-%d)

          COUNT=$(gh api \
            "/repos/${{ github.repository }}/actions/workflows/ai-1-quick-triage.yml/runs?status=success&created=>=$TODAY" \
            --jq '.total_count')

          echo "Today's runs: $COUNT / $DAILY_LIMIT"

          if [ "$COUNT" -ge "$DAILY_LIMIT" ]; then
            echo "exceeded=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Daily limit reached ($COUNT/$DAILY_LIMIT)"
          else
            echo "exceeded=false" >> $GITHUB_OUTPUT
            echo "remaining=$((DAILY_LIMIT - COUNT))" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        if: steps.limit.outputs.exceeded != 'true'
        with:
          sparse-checkout: README.md
          sparse-checkout-cone-mode: false

      - name: Gather context
        if: steps.limit.outputs.exceeded != 'true'
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number || inputs.issue_number }}

          # Get issue details (for workflow_dispatch)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_JSON=$(gh issue view $ISSUE_NUM --json title,body)
            echo "title=$(echo "$ISSUE_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "$ISSUE_JSON" | jq -r '.body // ""' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

          # Fetch previous issues (number and title only)
          gh issue list --state all --limit 50 --json number,title \
            --jq ".[] | select(.number != $ISSUE_NUM) | \"#\\(.number) \\(.title)\"" \
            > /tmp/issues.txt

      - name: Triage
        if: steps.limit.outputs.exceeded != 'true'
        id: triage
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Build prompt
          PROMPT=$(cat <<'EOF'
          You are a GitHub issue triage bot. Make a quick decision based on limited information.

          ## Project (from README)
          PROJECT_README

          ## Existing Issues
          EXISTING_ISSUES

          ## New Issue #ISSUE_NUM
          Title: ISSUE_TITLE
          Body: ISSUE_BODY

          ## Decision Required
          Based ONLY on the README and issue list above, determine:
          1. Is this SPAM or OUT OF SCOPE? (ads, gibberish, abuse, unrelated to project) â†’ "invalid"
          2. Is this a DUPLICATE? (very similar to existing issue) â†’ "duplicate"
          3. Is this UNCLEAR? (missing reproduction steps, environment, or details) â†’ "question"
          4. Otherwise â†’ "valid"

          Respond with JSON only:
          {
            "decision": "invalid" | "duplicate" | "question" | "valid",
            "duplicate_of": <issue number or null>,
            "reason": "one sentence explanation",
            "questions": ["question1", ...] // only if decision is "question"
          }
          EOF
          )

          # Replace placeholders
          README_CONTENT=$(head -50 README.md 2>/dev/null || echo "No README")
          EXISTING=$(cat /tmp/issues.txt)

          PROMPT="${PROMPT//PROJECT_README/$README_CONTENT}"
          PROMPT="${PROMPT//EXISTING_ISSUES/$EXISTING}"
          PROMPT="${PROMPT//ISSUE_NUM/${{ github.event.issue.number || inputs.issue_number }}}"
          PROMPT="${PROMPT//ISSUE_TITLE/${{ steps.context.outputs.title }}}"
          PROMPT="${PROMPT//ISSUE_BODY/${{ steps.context.outputs.body }}}"

          # Call API
          RESPONSE=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "content-type: application/json" \
            -H "anthropic-version: 2023-06-01" \
            -d "$(jq -n --arg p "$PROMPT" '{
              model: "claude-sonnet-4-20250514",
              max_tokens: 256,
              messages: [{role: "user", content: $p}]
            }')")

          # Debug: show full API response
          echo "=== API Response ==="
          echo "$RESPONSE" | jq '.'
          echo "==================="

          # Check for API error
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "API Error: $(echo "$RESPONSE" | jq -r '.error.message')"
            exit 1
          fi

          # Extract text content
          TEXT=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')
          echo "=== LLM Text ==="
          echo "$TEXT"
          echo "================"

          # Parse JSON from text (handle multiline JSON)
          RESULT=$(echo "$TEXT" | jq -c '.' 2>/dev/null || echo "$TEXT" | sed -n '/{/,/}/p' | jq -c '.' 2>/dev/null || echo '{}')
          echo "Parsed result: $RESULT"

          # Parse outputs
          echo "decision=$(echo "$RESULT" | jq -r '.decision // "valid"')" >> $GITHUB_OUTPUT
          echo "duplicate_of=$(echo "$RESULT" | jq -r '.duplicate_of // empty')" >> $GITHUB_OUTPUT
          echo "reason=$(echo "$RESULT" | jq -r '.reason // "Could not parse response"')" >> $GITHUB_OUTPUT
          echo "questions=$(echo "$RESULT" | jq -c '.questions // []')" >> $GITHUB_OUTPUT

      - name: "Close: Invalid"
        if: steps.triage.outputs.decision == 'invalid'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REASON: ${{ steps.triage.outputs.reason }}
        run: |
          COMMENT=$(cat <<'EOF'
          Hi there! ðŸ‘‹

          Thank you for taking the time to open this issue. After an initial review, it appears this issue may not be directly related to this project's scope.

          **Reason:** REASON_PLACEHOLDER

          If you believe this was a mistake, please feel free to reopen this issue with additional context, or open a new issue with more details about how this relates to the project.

          ðŸ¤– *This is an automated response generated by AI. The assessment may not be fully accurate. If you think this decision is incorrect, please let us know!*
          EOF
          )
          COMMENT="${COMMENT//REASON_PLACEHOLDER/$REASON}"

          gh issue close ${{ github.event.issue.number || inputs.issue_number }} \
            --reason "not planned" \
            --comment "$COMMENT"
          gh issue edit ${{ github.event.issue.number || inputs.issue_number }} \
            --add-label "invalid,triaged"

      - name: "Close: Duplicate"
        if: steps.triage.outputs.decision == 'duplicate'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DUP="${{ steps.triage.outputs.duplicate_of }}"
          if [ -n "$DUP" ] && [ "$DUP" != "null" ]; then
            COMMENT=$(cat <<EOF
          Hi there! ðŸ‘‹

          Thank you for reporting this! It looks like this issue has already been discussed in #$DUP.

          To avoid splitting the conversation, we're closing this as a duplicate. Please follow **#$DUP** for updates and feel free to add any additional context there.

          ðŸ¤– *This is an automated response generated by AI. If you believe this is not a duplicate, please reopen this issue and explain the difference.*
          EOF
          )
          else
            COMMENT=$(cat <<'EOF'
          Hi there! ðŸ‘‹

          Thank you for reporting this! It looks like this issue may have already been discussed in an existing issue.

          We're closing this as a potential duplicate. Please search through existing issues to find the related discussion and add your input there.

          ðŸ¤– *This is an automated response generated by AI. If you believe this is not a duplicate, please reopen this issue and let us know!*
          EOF
          )
          fi

          gh issue close ${{ github.event.issue.number || inputs.issue_number }} \
            --reason "not planned" \
            --comment "$COMMENT"
          gh issue edit ${{ github.event.issue.number || inputs.issue_number }} \
            --add-label "duplicate,triaged"

      - name: "Request: Clarification"
        if: steps.triage.outputs.decision == 'question'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          QUESTIONS: ${{ steps.triage.outputs.questions }}
        run: |
          QLIST=$(echo "$QUESTIONS" | jq -r 'if length > 0 then .[] | "- " + . else empty end')

          COMMENT=$(cat <<EOF
          Hi there! ðŸ‘‹

          Thank you for opening this issue! We'd love to help, but we need a bit more information to understand your situation better.

          Could you please provide some additional details?

          $QLIST

          This will help us investigate and respond more effectively. Thanks for your patience!

          ðŸ¤– *This is an automated response generated by AI. The questions above may not perfectly match your situation - please share whatever context you think is relevant!*
          EOF
          )

          gh issue comment ${{ github.event.issue.number || inputs.issue_number }} \
            --body "$COMMENT"
          gh issue edit ${{ github.event.issue.number || inputs.issue_number }} \
            --add-label "question,triaged"

      - name: "Pass: Valid"
        if: steps.triage.outputs.decision == 'valid'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number || inputs.issue_number }} \
            --add-label "valid,triaged"

          echo "âœ“ Issue passed quick triage: ${{ steps.triage.outputs.reason }}"

          # Trigger Stage 2 (uncomment when ready)
          # gh workflow run stage2-deep-analysis.yml \
          #   -f issue_number=${{ github.event.issue.number || inputs.issue_number }}
