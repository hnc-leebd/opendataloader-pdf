name: "AI Issue: Stage 2 - Analyze"

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

env:
  DAILY_LIMIT: 5

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      actions: read

    # Run when:
    # 1. workflow_dispatch (manual)
    # 2. ai-issue/valid label added (from Stage 1)
    # 3. comment on issue with ai-issue/needs-info label (user responded)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.label.name == 'ai-issue/valid') ||
      (github.event_name == 'issue_comment' && contains(github.event.issue.labels.*.name, 'ai-issue/needs-info'))

    steps:
      - name: Check preconditions
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get issue number based on event type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUM=${{ inputs.issue_number }}
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUM=${{ github.event.issue.number }}
          else
            ISSUE_NUM=${{ github.event.issue.number }}
          fi
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

          # Check daily limit
          TODAY=$(date -u +%Y-%m-%d)
          COUNT=$(gh api \
            "/repos/${{ github.repository }}/actions/workflows/ai-issue-2-analyze.yml/runs?status=success&created=>=$TODAY" \
            --jq '.total_count')

          echo "Today's runs: $COUNT / $DAILY_LIMIT"
          if [ "$COUNT" -ge "$DAILY_LIMIT" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Daily limit reached ($COUNT/$DAILY_LIMIT)" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if already analyzed
          LABELS=$(gh issue view $ISSUE_NUM --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -q "ai-issue/analyzed"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Already analyzed" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if valid or needs-info (passed Stage 1)
          if ! echo "$LABELS" | grep -qE "ai-issue/valid|ai-issue/needs-info"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Issue not marked as ai-issue/valid or ai-issue/needs-info (Stage 1 not passed)" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Skip notification
        if: steps.check.outputs.skip == 'true'
        run: |
          echo "âš ï¸ Skipping: ${{ steps.check.outputs.reason }}"

      - uses: actions/checkout@v4
        if: steps.check.outputs.skip != 'true'

      - name: Setup Node.js
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Gather context
        if: steps.check.outputs.skip != 'true'
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          # Get full issue details
          gh issue view $ISSUE_NUM --json title,body,labels,comments > /tmp/issue.json

      - name: Run analysis
        if: steps.check.outputs.skip != 'true'
        id: analysis
        timeout-minutes: 15
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          # Build prompt using shared script
          .github/scripts/ai-issue/build-stage2-prompt.sh "$ISSUE_NUM" "/tmp/issue.json" > /tmp/analysis_prompt.txt

          # Run Claude Code CLI using shared script
          RESULT=$(.github/scripts/ai-issue/call-claude-code.sh /tmp/analysis_prompt.txt "Read,Glob,Grep")

          echo "=== Analysis Result ==="
          echo "$RESULT"
          echo "======================="

          # Parse response using shared script (writes files to /tmp)
          PARSED=$(echo "$RESULT" | .github/scripts/ai-issue/parse-stage2-response.sh /tmp)

          echo "=== Parsed Result ==="
          echo "$PARSED"
          echo "====================="

          # Output to GitHub Actions
          echo "$PARSED" >> $GITHUB_OUTPUT

      - name: Post analysis comment
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSIGNEE: ${{ steps.analysis.outputs.assignee }}
          PRIORITY: ${{ steps.analysis.outputs.priority }}
          ESTIMATED: ${{ steps.analysis.outputs.estimated }}
          ACTION: ${{ steps.analysis.outputs.action }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          # Read analysis from files
          SUMMARY=$(cat /tmp/analysis_summary.txt)
          EXPECTED=$(cat /tmp/expected_behavior.txt)
          CURRENT=$(cat /tmp/current_behavior.txt)
          FILES=$(cat /tmp/affected_files.txt)
          ROOT_CAUSE=$(cat /tmp/root_cause.txt)
          APPROACH=$(cat /tmp/suggested_approach.txt)
          AUTO_FIX_RATIONALE=$(cat /tmp/auto_fix_rationale.txt)

          # Build conditional sections
          EXPECTED_SECTION=""
          if [ -n "$EXPECTED" ]; then
            EXPECTED_SECTION="### Expected Behavior
          $EXPECTED"
          fi

          CURRENT_SECTION=""
          if [ -n "$CURRENT" ]; then
            CURRENT_SECTION="### Current Behavior
          $CURRENT"
          fi

          ROOT_CAUSE_SECTION=""
          if [ -n "$ROOT_CAUSE" ]; then
            ROOT_CAUSE_SECTION="### Root Cause
          $ROOT_CAUSE"
          fi

          # Determine action badge
          if [ "$ACTION" = "auto_fix" ]; then
            ACTION_BADGE="ðŸ¤– **Auto-fix eligible** - Stage 3 can attempt automatic fix"
          else
            ACTION_BADGE="ðŸ‘¤ **Manual fix required** - Assigned for human implementation"
          fi

          COMMENT=$(cat <<EOF
          ## ðŸ” AI Deep Analysis

          ### Summary
          $SUMMARY

          $EXPECTED_SECTION

          $CURRENT_SECTION

          ### Affected Files
          \`$FILES\`

          $ROOT_CAUSE_SECTION

          ### Suggested Approach
          $APPROACH

          ---

          ## ðŸ“‹ Triage Decision

          $ACTION_BADGE

          | Field | Value |
          |-------|-------|
          | **Priority** | $PRIORITY |
          | **Estimate** | $ESTIMATED story points |
          | **Assignee** | @$ASSIGNEE |

          <details>
          <summary>Auto-fix rationale</summary>

          $AUTO_FIX_RATIONALE

          </details>

          ---
          ðŸ¤– *This analysis was generated by AI and may be inaccurate or inappropriate. If something seems off, please let us know!*
          EOF
          )

          gh issue comment $ISSUE_NUM --body "$COMMENT"

          # Assign to recommended member
          if [ -n "$ASSIGNEE" ]; then
            gh issue edit $ISSUE_NUM --add-assignee "$ASSIGNEE" || echo "Failed to assign to $ASSIGNEE"
          fi

      - name: Update labels
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LABELS: ${{ steps.analysis.outputs.labels }}
          ACTION: ${{ steps.analysis.outputs.action }}
          PRIORITY: ${{ steps.analysis.outputs.priority }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          # Build label arguments
          LABEL_ARGS=""
          for label in $(echo "$LABELS" | jq -r '.[]'); do
            # Convert old labels to new format (type/*)
            case "$label" in
              bug) LABEL_ARGS="$LABEL_ARGS --add-label \"type/bug\"" ;;
              enhancement) LABEL_ARGS="$LABEL_ARGS --add-label \"type/enhancement\"" ;;
              documentation) LABEL_ARGS="$LABEL_ARGS --add-label \"type/docs\"" ;;
              dependencies) LABEL_ARGS="$LABEL_ARGS --add-label \"type/dependencies\"" ;;
              *) LABEL_ARGS="$LABEL_ARGS --add-label \"$label\"" ;;
            esac
          done

          # Add priority label (priority/P0, priority/P1, priority/P2)
          LABEL_ARGS="$LABEL_ARGS --add-label \"priority/$PRIORITY\""

          # Add fix/auto-eligible label if applicable
          if [ "$ACTION" = "auto_fix" ]; then
            LABEL_ARGS="$LABEL_ARGS --add-label \"fix/auto-eligible\""
          fi

          # Add ai-issue/analyzed label
          LABEL_ARGS="$LABEL_ARGS --add-label \"ai-issue/analyzed\""

          eval gh issue edit $ISSUE_NUM $LABEL_ARGS

      - name: Log Stage 3 eligibility
        if: steps.check.outputs.skip != 'true' && steps.analysis.outputs.action == 'auto_fix'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ steps.check.outputs.issue_number }}

          echo "âœ… Issue #$ISSUE_NUM is eligible for auto-fix"
          echo "Has fix/auto-eligible label - Stage 3 can be triggered manually:"
          echo "  gh workflow run ai-issue-3-fix.yml -f issue_number=$ISSUE_NUM"
