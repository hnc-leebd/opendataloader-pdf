name: "Stage 3: Auto Fix"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number

env:
  DAILY_LIMIT: 3

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Check preconditions
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ inputs.issue_number }}

          # Check daily limit
          TODAY=$(date -u +%Y-%m-%d)
          COUNT=$(gh api \
            "/repos/${{ github.repository }}/actions/workflows/ai-triage-3-fix.yml/runs?status=success&created=>=$TODAY" \
            --jq '.total_count')

          echo "Today's runs: $COUNT / $DAILY_LIMIT"
          if [ "$COUNT" -ge "$DAILY_LIMIT" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Daily limit reached ($COUNT/$DAILY_LIMIT)" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check labels
          LABELS=$(gh issue view $ISSUE_NUM --repo ${{ github.repository }} --json labels --jq '.labels[].name')

          # Must have fix/auto-eligible label
          if ! echo "$LABELS" | grep -q "fix/auto-eligible"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Issue not marked as fix/auto-eligible (Stage 2 did not approve)" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Must have triage/deep label
          if ! echo "$LABELS" | grep -q "triage/deep"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Issue not deep-triaged (Stage 2 not completed)" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if already fixed (has triage/fixed label)
          if echo "$LABELS" | grep -q "triage/fixed"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=Issue already has triage/fixed label" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Skip notification
        if: steps.check.outputs.skip == 'true'
        run: |
          echo "âš ï¸ Skipping: ${{ steps.check.outputs.reason }}"

      - uses: actions/checkout@v4
        if: steps.check.outputs.skip != 'true'

      - name: Setup Node.js
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Gather context
        if: steps.check.outputs.skip != 'true'
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ inputs.issue_number }}

          # Get full issue details including comments (for AI analysis from Stage 2)
          gh issue view $ISSUE_NUM --json title,body,labels,comments > /tmp/issue.json

          # Extract title for PR
          ISSUE_TITLE=$(cat /tmp/issue.json | jq -r '.title')
          echo "title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

          # Extract AI analysis comment if present
          cat /tmp/issue.json | jq -r '.comments[] | select(.body | contains("AI Deep Analysis")) | .body' | head -1 > /tmp/ai_analysis.txt || true

      - name: Run Claude Code - Fix
        if: steps.check.outputs.skip != 'true'
        id: fix
        timeout-minutes: 30
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM=${{ inputs.issue_number }}
          ISSUE_TITLE="${{ steps.context.outputs.title }}"
          ISSUE_JSON=$(cat /tmp/issue.json)
          AI_ANALYSIS=$(cat /tmp/ai_analysis.txt 2>/dev/null || echo "No AI analysis available")

          # Create branch
          BRANCH="ai-fix/issue-$ISSUE_NUM"
          git checkout -b "$BRANCH"

          # Build prompt with AI analysis context
          FIX_PROMPT=$(cat <<'FIX_EOF'
          You are fixing GitHub issue #ISSUE_NUM_PLACEHOLDER.

          ## Issue Details
          ISSUE_JSON_PLACEHOLDER

          ## AI Analysis from Stage 2
          The following analysis was performed by AI in the previous stage. Use this to understand the issue better:

          AI_ANALYSIS_PLACEHOLDER

          ## Instructions
          Based on the issue and AI analysis above:
          1. Locate the affected files mentioned in the analysis
          2. Understand the root cause and suggested approach
          3. Write a test that reproduces the issue (if applicable)
          4. Implement the fix following the suggested approach
          5. Verify tests pass
          6. Ensure the build succeeds
          7. Only make minimal, focused changes

          ## Output Format
          After completing the fix, output a summary in the following format:

          ---FIX_SUMMARY_START---
          SUCCESS: true/false
          CHANGES: <list of files changed and why>
          VERIFICATION: <how you verified the fix works>
          ---FIX_SUMMARY_END---

          Do NOT create a PR - just make the code changes and verify they work.
          FIX_EOF
          )

          # Replace placeholders
          FIX_PROMPT="${FIX_PROMPT//ISSUE_NUM_PLACEHOLDER/$ISSUE_NUM}"
          FIX_PROMPT="${FIX_PROMPT//ISSUE_JSON_PLACEHOLDER/$ISSUE_JSON}"
          FIX_PROMPT="${FIX_PROMPT//AI_ANALYSIS_PLACEHOLDER/$AI_ANALYSIS}"

          # Save prompt to file (avoid argument length limits)
          echo "$FIX_PROMPT" > /tmp/fix_prompt.txt

          FIX_RESULT=$(cat /tmp/fix_prompt.txt | npx -y @anthropic-ai/claude-code \
            --print \
            --verbose \
            --allowedTools "Read,Glob,Grep,Edit,Write,Bash" \
            2>&1 || echo "FIX_FAILED")

          echo "=== Fix Result ==="
          echo "$FIX_RESULT"
          echo "=================="

          # Save full output for PR body
          echo "$FIX_RESULT" > /tmp/fix_result.txt

          # Extract summary section if present
          SUMMARY_SECTION=$(sed -n '/---FIX_SUMMARY_START---/,/---FIX_SUMMARY_END---/p' /tmp/fix_result.txt | sed '1d;$d' || echo "")
          echo "$SUMMARY_SECTION" > /tmp/fix_summary.txt

          # Check if fix was successful (has changes)
          if [ -n "$(git status --porcelain)" ]; then
            # Get list of changed files
            CHANGED_FILES=$(git diff --name-only HEAD)
            echo "$CHANGED_FILES" > /tmp/changed_files.txt

            # Commit changes
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "fix: resolve issue #$ISSUE_NUM - $ISSUE_TITLE

          ðŸ¤– Generated with Claude Code

          Co-Authored-By: Claude <noreply@anthropic.com>"

            git push origin "$BRANCH"

            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "fail_reason=No changes were made" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.skip != 'true' && steps.fix.outputs.success == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ steps.fix.outputs.branch }}
        run: |
          ISSUE_NUM=${{ inputs.issue_number }}
          ISSUE_TITLE="${{ steps.context.outputs.title }}"

          SUMMARY_SECTION=$(cat /tmp/fix_summary.txt)
          CHANGED_FILES=$(cat /tmp/changed_files.txt)

          # Build PR body
          PR_BODY=$(cat <<EOF
          ## Summary
          Automated fix for #$ISSUE_NUM: **$ISSUE_TITLE**

          ## AI Fix Summary
          \`\`\`
          $SUMMARY_SECTION
          \`\`\`

          ## Changed Files
          \`\`\`
          $CHANGED_FILES
          \`\`\`

          ## Test Plan
          - [ ] Tests pass
          - [ ] Build succeeds
          - [ ] Manual verification

          ---
          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Closes #$ISSUE_NUM
          EOF
          )

          # Create PR
          PR_URL=$(gh pr create \
            --title "fix: resolve issue #$ISSUE_NUM - $ISSUE_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Post Success Comment
        if: steps.check.outputs.skip != 'true' && steps.fix.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ steps.pr.outputs.pr_url }}
        run: |
          ISSUE_NUM=${{ inputs.issue_number }}

          COMMENT=$(cat <<EOF
          ## ðŸŽ‰ Auto-Fix Complete

          I've analyzed this issue and created a fix!

          **Pull Request:** $PR_URL

          Please review the changes and merge if everything looks good.

          ---
          ðŸ¤– *This fix was generated by AI and may be inaccurate or inappropriate. Please review carefully before merging!*
          EOF
          )

          gh issue comment $ISSUE_NUM --body "$COMMENT"

          # Add triage/fixed label
          gh issue edit $ISSUE_NUM --add-label "triage/fixed"

      - name: Post Failure Comment
        if: steps.check.outputs.skip != 'true' && steps.fix.outputs.success != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FAIL_REASON: ${{ steps.fix.outputs.fail_reason }}
        run: |
          ISSUE_NUM=${{ inputs.issue_number }}

          COMMENT=$(cat <<EOF
          ## âš ï¸ Auto-Fix Failed

          I attempted to automatically fix this issue, but encountered some difficulties.

          **Reason:** $FAIL_REASON

          This issue will need manual attention. The AI analysis from Stage 2 should still be helpful for understanding the problem.

          ---
          ðŸ¤– *This is an automated response generated by AI.*
          EOF
          )

          gh issue comment $ISSUE_NUM --body "$COMMENT"

          # Remove fix/auto-eligible label, add fix/manual-required
          gh issue edit $ISSUE_NUM --remove-label "fix/auto-eligible" --add-label "fix/manual-required"
